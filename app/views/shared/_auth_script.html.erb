<script>
  (function() {
    let authSubscription = null
    let sessionToken = null
    let cable = null
    let authButtonInitialized = false

    // Определяем, открыт ли сайт во встроенном браузере Telegram
    function isTelegramWebView() {
      // Проверяем наличие Telegram WebView API
      if (typeof window.TelegramWebviewProxy !== 'undefined') {
        return true;
      }

      // Проверяем Telegram Web App
      if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
        return true;
      }

      // Запасная проверка через User Agent
      const ua = navigator.userAgent || '';
      return /telegram/i.test(ua);
    }

    // Определяем мобильное устройство
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Проверяем авторизацию при загрузке страницы и при каждой навигации через Turbo
    const initAuth = () => {
      const authButton = document.getElementById('auth-button')
      if (!authButton) return

      // Проверяем текущий статус только если кнопка не имеет server-side rendered состояния
      // или если нужно обновить состояние
      const isServerRendered = authButton.hasAttribute('data-authenticated')
      if (!isServerRendered) {
        checkAuthStatus(authButton)
      }

      // ЗАЩИТА: Проверяем авторизацию на странице урока при загрузке
      checkAuthOnPageLoad()

      // Добавляем обработчик клика только один раз
      if (!authButtonInitialized) {
        authButtonInitialized = true

        // Используем делегирование событий на document для обработки клика
        document.addEventListener('click', async (e) => {
          const authBtn = e.target.closest('#auth-button')
          if (!authBtn || authBtn.disabled) return

          e.preventDefault()
          authBtn.disabled = true
          authBtn.classList.add('opacity-75')

          // Очищаем старые данные хранилища (для Safari)
          try {
            localStorage.removeItem('auth_session_token')
            sessionStorage.clear()
          } catch (e) {
            console.log('Storage clear error:', e)
          }

          try {
            const response = await fetch('/auth/telegram/start', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
              },
              credentials: 'include'  // Для cross-subdomain cookie sharing
            })

            const data = await response.json()

            if (data.success) {
              sessionToken = data.session_token

              // Отладка: выводим информацию о детекции
              console.log('=== AUTH DEBUG ===')
              console.log('Is Telegram WebView:', isTelegramWebView())
              console.log('Is Mobile Device:', isMobileDevice())
              console.log('User Agent:', navigator.userAgent)
              console.log('TelegramWebviewProxy:', typeof window.TelegramWebviewProxy)
              console.log('Telegram.WebApp:', typeof window.Telegram !== 'undefined' ? typeof window.Telegram.WebApp : 'undefined')
              console.log('Deep Link:', data.deep_link)

              // Для Telegram WebView ИЛИ мобильного браузера используем одинаковую логику
              if (isTelegramWebView() || isMobileDevice()) {
                console.log('>>> TELEGRAM WEBVIEW OR MOBILE - using location.href method')

                // Для Safari на iOS используем location.href вместо link.click()
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent)

                if (isSafari) {
                  console.log('>>> Safari detected - using location.href')
                  // Сохраняем токен перед переходом
                  localStorage.setItem('auth_session_token', sessionToken)
                  // Используем location.href для Safari
                  window.location.href = data.deep_link
                } else {
                  // Для остальных браузеров используем старый метод
                  const link = document.createElement('a')
                  link.href = data.deep_link // https://t.me/bot?start=xxx

                  // ВАЖНО: target="_blank" только для мобильного браузера, НЕ для Telegram WebView
                  if (!isTelegramWebView() && isMobileDevice()) {
                    link.target = '_blank'
                  }

                  link.style.display = 'none'
                  document.body.appendChild(link)

                  // Программно кликаем - Telegram перехватит и откроет бота нативно
                  link.click()
                  document.body.removeChild(link)
                }

                // Сбрасываем состояние кнопки
                authBtn.disabled = false
                authBtn.classList.remove('opacity-75')

                // Когда пользователь вернётся из бота - сразу проверяем авторизацию
                const handleReturn = async () => {
                  if (!document.hidden) {
                    document.removeEventListener('visibilitychange', handleReturn)

                    console.log('>>> User returned from bot')

                    // Для Safari восстанавливаем токен из localStorage
                    if (!sessionToken && localStorage.getItem('auth_session_token')) {
                      sessionToken = localStorage.getItem('auth_session_token')
                      console.log('>>> Restored session token from localStorage')
                    }

                    showWaitingStatus(authBtn)

                    // СРАЗУ проверяем авторизацию через API
                    try {
                      const response = await fetch(`/auth/check_token?session_token=${sessionToken}`, {
                        credentials: 'include'
                      })
                      const result = await response.json()

                      console.log('>>> Auth check result:', result)

                      if (result.authenticated) {
                        // Авторизация успешна!
                        console.log('>>> Authentication successful!')
                        updateButtonAsAuthenticated(authBtn, result.user)
                        showSuccessNotification()

                        // Перезагружаем страницу
                        setTimeout(() => {
                          window.location.reload()
                        }, 1500)
                      } else {
                        // Если еще не авторизован - подключаем WebSocket
                        console.log('>>> Not authenticated yet, connecting WebSocket')
                        subscribeToAuth(sessionToken)
                      }
                    } catch (error) {
                      console.error('>>> Auth check failed:', error)
                      // При ошибке - пробуем через WebSocket
                      subscribeToAuth(sessionToken)
                    }
                  }
                }
                document.addEventListener('visibilitychange', handleReturn)
              } else {
                console.log('>>> REGULAR BROWSER DETECTED - using window.open')
                // В обычном браузере открываем в новой вкладке
                window.open(data.deep_link, '_blank')

                // Подключаемся к WebSocket
                subscribeToAuth(sessionToken)

                // Показываем статус ожидания
                showWaitingStatus(authBtn)
              }
            }
          } catch (error) {
            console.error('Auth failed:', error)
            authBtn.disabled = false
            authBtn.classList.remove('opacity-75')
          }
        })
      }

      // Обработчик кликов на ссылки уроков
      setupLessonLinks()
    }

    async function checkAuthStatus(button) {
      try {
        const response = await fetch('/auth/status', { credentials: 'include' })
        const data = await response.json()

        if (data.authenticated && data.user) {
          updateButtonAsAuthenticated(button, data.user)
          return true
        }
        return false
      } catch (error) {
        console.error('Auth status check failed:', error)
        return false
      }
    }

    // Проверка авторизации при загрузке страницы урока
    async function checkAuthOnPageLoad() {
      // Проверяем есть ли на странице блок контента урока (значит это страница урока)
      const lessonContent = document.getElementById('lesson-content-blur')
      if (!lessonContent) return // Это не страница урока, выходим

      console.log('>>> Checking auth on lesson page load')

      // Проверяем авторизацию
      try {
        const response = await fetch('/auth/status', { credentials: 'include' })
        const data = await response.json()

        console.log('>>> Auth status on page load:', data.authenticated)

        if (!data.authenticated) {
          // Пользователь НЕ авторизован - размываем контент и показываем модальное окно
          console.log('>>> User not authenticated - showing modal and blurring content')
          lessonContent.classList.add('blur-md')
          showAuthModal()
        }
      } catch (error) {
        console.error('Auth check on page load failed:', error)
      }
    }

    function setupLessonLinks() {
      const lessonLinks = document.querySelectorAll('a[href^="/freecontent/"][href$="-intro"], a[href^="/freecontent/"][href*="-"]')

      lessonLinks.forEach(link => {
        // Удаляем старый обработчик если есть
        link.removeEventListener('click', link._authCheckHandler)

        // Создаем новый обработчик
        link._authCheckHandler = async (e) => {
          const isAuthed = await checkAuthStatus(document.getElementById('auth-button'))

          if (!isAuthed) {
            e.preventDefault()
            showAuthModal()
          }
        }

        // Добавляем обработчик
        link.addEventListener('click', link._authCheckHandler)
      })
    }

    function subscribeToAuth(token) {
      console.log('Subscribing to AuthChannel with token:', token)

      // Создаем ActionCable consumer
      if (!cable) {
        cable = ActionCable.createConsumer('/cable')
      }

      // Подписываемся на канал
      authSubscription = cable.subscriptions.create(
        {
          channel: 'AuthChannel',
          session_token: token
        },
        {
          connected() {
            console.log('Connected to AuthChannel')
          },
          disconnected() {
            console.log('Disconnected from AuthChannel')
          },
          received(data) {
            console.log('Received data from AuthChannel:', data)
            if (data.type === 'authenticated') {
              handleAuthSuccess(data)
            }
          }
        }
      )
    }

    async function handleAuthSuccess(data) {
      console.log('handleAuthSuccess called with:', data)

      // Проверяем токен на сервере чтобы сохранить сессию
      try {
        const response = await fetch(`/auth/check_token?session_token=${data.session_token || sessionToken}`, {
          credentials: 'include'
        })
        const result = await response.json()

        if (result.authenticated) {
          const authButton = document.getElementById('auth-button')
          updateButtonAsAuthenticated(authButton, result.user)

          // Закрываем модальное окно
          hideAuthModal()

          // Показываем уведомление
          showSuccessNotification()

          // Перезагружаем страницу
          setTimeout(() => {
            window.location.reload()
          }, 1500)
        }
      } catch (error) {
        console.error('Failed to check token:', error)
      }
    }

    function showWaitingStatus(button) {
      button.innerHTML = `
        <span class="flex items-center gap-2">
          <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Ожидание...
        </span>
      `
    }

    function updateButtonAsAuthenticated(button, user) {
      if (!button) return

      // Заменяем кнопку авторизации на dropdown профиля
      const container = button.parentElement

      const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ') || 'Пользователь'
      const firstLetter = (user.first_name || 'U')[0].toUpperCase()
      const username = user.username ? `@${user.username}` : ''

      container.innerHTML = `
        <div class="relative" data-authenticated="true" data-controller="dropdown">
          <!-- Кнопка-триггер dropdown -->
          <button data-action="click->dropdown#toggle" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-1.5 px-3 rounded-lg transition-all flex items-center gap-2 text-sm">
            <div class="w-7 h-7 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-xs">
              ${firstLetter}
            </div>
            <span>${user.first_name || 'Профиль'}</span>
            <svg class="w-3.5 h-3.5 transition-transform text-gray-500" data-dropdown-target="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <!-- Dropdown меню -->
          <div data-dropdown-target="menu" class="hidden absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden z-50">
            <!-- Заголовок профиля -->
            <div class="px-4 py-3 bg-gradient-to-r from-blue-50 to-blue-100 border-b border-blue-200">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                  ${firstLetter}
                </div>
                <div>
                  <div class="font-bold text-gray-900">${fullName}</div>
                  ${username ? `<div class="text-sm text-gray-600">${username}</div>` : ''}
                </div>
              </div>
            </div>

            <!-- Пункты меню -->
            <div class="py-2">
              <a href="/" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-100 transition-colors text-gray-700">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span>Главная</span>
              </a>

              <a href="/freecontent" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-100 transition-colors text-gray-700">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <span>Курс</span>
              </a>

              ${user.admin ? `
                <a href="/messenger" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-100 transition-colors text-gray-700">
                  <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                  <span>Messenger</span>
                </a>
              ` : ''}

              <div class="border-t border-gray-200 my-2"></div>

              <form action="/auth/logout" method="post" data-turbo="false">
                <input type="hidden" name="_method" value="delete">
                <input type="hidden" name="authenticity_token" value="${document.querySelector('[name="csrf-token"]')?.content}">
                <button type="submit" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-50 transition-colors text-red-600 text-left">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                  </svg>
                  <span>Выйти</span>
                </button>
              </form>
            </div>
          </div>
        </div>
      `
    }

    function showAuthModal() {
      const modal = document.getElementById('auth-modal')
      if (modal) {
        modal.classList.remove('hidden')

        // Размываем контент урока
        const lessonContent = document.getElementById('lesson-content-blur')
        if (lessonContent) {
          lessonContent.classList.add('blur-md')
        }

        // Анимация кнопки авторизации
        const authButton = document.getElementById('auth-button')
        if (authButton) {
          authButton.classList.add('animate-pulse')
          setTimeout(() => {
            authButton.classList.remove('animate-pulse')
          }, 3000)
        }
      }
    }

    function hideAuthModal() {
      const modal = document.getElementById('auth-modal')
      if (modal) {
        modal.classList.add('hidden')

        // Убираем размытие контента урока
        const lessonContent = document.getElementById('lesson-content-blur')
        if (lessonContent) {
          lessonContent.classList.remove('blur-md')
        }
      }
    }

    function showSuccessNotification() {
      const notification = document.createElement('div')
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 animate-bounce'
      notification.innerHTML = '✅ Авторизация успешна!'
      document.body.appendChild(notification)

      setTimeout(() => {
        notification.remove()
      }, 2000)
    }

    // Инициализация при загрузке страницы и при навигации через Turbo
    document.addEventListener('turbo:load', initAuth)
    document.addEventListener('DOMContentLoaded', initAuth)

    // Экспортируем функции для использования в других местах
    window.showAuthModal = showAuthModal
    window.hideAuthModal = hideAuthModal
  })();
</script>
